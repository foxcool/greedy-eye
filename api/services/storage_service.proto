syntax = "proto3";

package services;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/field_mask.proto";
import "google/api/annotations.proto";
import "api/models/account.proto";
import "api/models/asset.proto";
import "api/models/holding.proto";
import "api/models/portfolio.proto";
import "api/models/price.proto";
import "api/models/transaction.proto";
import "api/models/user.proto";
import "api/models/rule.proto";
import "api/models/rule_execution.proto";

option go_package = "github.com/foxcool/greedy-eye/internal/api/services";

// StorageService provides low-level CRUD operations for all core entities.
// It acts as an abstraction layer over the database.
service StorageService {
  // --- Asset operations ---
  rpc CreateAsset(CreateAssetRequest) returns (models.Asset) {
    option (google.api.http) = {
      post: "/api/v1/assets"
      body: "asset"
    };
  }
  rpc GetAsset(GetAssetRequest) returns (models.Asset) {
    option (google.api.http) = {
      get: "/api/v1/assets/{id}"
    };
  }
  rpc UpdateAsset(UpdateAssetRequest) returns (models.Asset) {
    option (google.api.http) = {
      put: "/api/v1/assets/{asset.id}"
      body: "asset"
    };
  }
  rpc DeleteAsset(DeleteAssetRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/api/v1/assets/{id}"
    };
  }
  rpc ListAssets(ListAssetsRequest) returns (ListAssetsResponse) {
    option (google.api.http) = {
      get: "/api/v1/assets"
    };
  }

  // --- Price operations ---
  // Assuming prices are immutable once created, so no UpdatePrice.
  rpc CreatePrice(CreatePriceRequest) returns (models.Price) {
    option (google.api.http) = {
      post: "/api/v1/prices"
      body: "price"
    };
  }
  rpc CreatePrices(CreatePricesRequest) returns (CreatePricesResponse) {
    option (google.api.http) = {
      post: "/api/v1/prices/bulk"
      body: "prices"
    };
  }
  rpc GetLatestPrice(GetLatestPriceRequest) returns (models.Price) {
    option (google.api.http) = {
      get: "/api/v1/prices/{asset_id}/{base_asset_id}/latest"
    };
  }
  rpc ListPriceHistory(ListPriceHistoryRequest) returns (ListPriceHistoryResponse) {
    option (google.api.http) = {
      get: "/api/v1/prices/{asset_id}/{base_asset_id}/history"
    };
  }
  rpc ListPricesByInterval(ListPricesByIntervalRequest) returns (ListPriceHistoryResponse) {
    option (google.api.http) = {
      get: "/api/v1/prices/{asset_id}/{base_asset_id}/intervals"
    };
  }
  rpc DeletePrice(DeletePriceRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/api/v1/prices/{id}"
    };
  }
  rpc DeletePrices(DeletePricesRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/api/v1/prices"
    };
  }

  // --- Portfolio operations ---
  rpc CreatePortfolio(CreatePortfolioRequest) returns (models.Portfolio) {
    option (google.api.http) = {
      post: "/api/v1/portfolios"
      body: "portfolio"
    };
  }
  rpc GetPortfolio(GetPortfolioRequest) returns (models.Portfolio) {
    option (google.api.http) = {
      get: "/api/v1/portfolios/{id}"
    };
  }
  rpc UpdatePortfolio(UpdatePortfolioRequest) returns (models.Portfolio) {
    option (google.api.http) = {
      put: "/api/v1/portfolios/{portfolio.id}"
      body: "portfolio"
    };
  }
  rpc DeletePortfolio(DeletePortfolioRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/api/v1/portfolios/{id}"
    };
  }
  rpc ListPortfolios(ListPortfoliosRequest) returns (ListPortfoliosResponse) {
    option (google.api.http) = {
      get: "/api/v1/portfolios"
    };
  }

  // --- Holdings operations ---
  rpc CreateHolding(CreateHoldingRequest) returns (models.Holding) {
    option (google.api.http) = {
      post: "/api/v1/holdings"
      body: "holding"
    };
  }
  rpc GetHolding(GetHoldingRequest) returns (models.Holding) {
    option (google.api.http) = {
      get: "/api/v1/holdings/{id}"
    };
  }
  rpc UpdateHolding(UpdateHoldingRequest) returns (models.Holding) {
    option (google.api.http) = {
      put: "/api/v1/holdings/{holding.id}"
      body: "holding"
    };
  }
  rpc ListHoldings(ListHoldingsRequest) returns (ListHoldingsResponse) {
    option (google.api.http) = {
      get: "/api/v1/holdings"
    };
  }

  // --- User operations ---
  rpc CreateUser(CreateUserRequest) returns (models.User) {
    option (google.api.http) = {
      post: "/api/v1/users"
      body: "user"
    };
  }
  rpc GetUser(GetUserRequest) returns (models.User) {
    option (google.api.http) = {
      get: "/api/v1/users/{id}"
    };
  }
  rpc UpdateUser(UpdateUserRequest) returns (models.User) {
    option (google.api.http) = {
      put: "/api/v1/users/{user.id}"
      body: "user"
    };
  }
  rpc DeleteUser(DeleteUserRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/api/v1/users/{id}"
    };
  }

  // --- Account operations ---
  rpc CreateAccount(CreateAccountRequest) returns (models.Account) {
    option (google.api.http) = {
      post: "/api/v1/accounts"
      body: "account"
    };
  }
  rpc GetAccount(GetAccountRequest) returns (models.Account) {
    option (google.api.http) = {
      get: "/api/v1/accounts/{id}"
    };
  }
  rpc UpdateAccount(UpdateAccountRequest) returns (models.Account) {
    option (google.api.http) = {
      put: "/api/v1/accounts/{account.id}"
      body: "account"
    };
  }
  rpc DeleteAccount(DeleteAccountRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/api/v1/accounts/{id}"
    };
  }
  rpc ListAccounts(ListAccountsRequest) returns (ListAccountsResponse) {
    option (google.api.http) = {
      get: "/api/v1/accounts"
    };
  }

  // --- Transaction operations ---
  rpc CreateTransaction(CreateTransactionRequest) returns (models.Transaction) {
    option (google.api.http) = {
      post: "/api/v1/transactions"
      body: "transaction"
    };
  }
  rpc GetTransaction(GetTransactionRequest) returns (models.Transaction) {
    option (google.api.http) = {
      get: "/api/v1/transactions/{id}"
    };
  }
  rpc UpdateTransaction(UpdateTransactionRequest) returns (models.Transaction) {
    option (google.api.http) = {
      put: "/api/v1/transactions/{transaction.id}"
      body: "transaction"
    };
  }
  rpc ListTransactions(ListTransactionsRequest) returns (ListTransactionsResponse) {
    option (google.api.http) = {
      get: "/api/v1/transactions"
    };
  }

  // --- Rule operations ---
  rpc CreateRule(CreateRuleRequest) returns (models.Rule) {
    option (google.api.http) = {
      post: "/api/v1/rules"
      body: "rule"
    };
  }
  rpc GetRule(GetRuleRequest) returns (models.Rule) {
    option (google.api.http) = {
      get: "/api/v1/rules/{id}"
    };
  }
  rpc UpdateRule(UpdateRuleRequest) returns (models.Rule) {
    option (google.api.http) = {
      put: "/api/v1/rules/{rule.id}"
      body: "rule"
    };
  }
  rpc DeleteRule(DeleteRuleRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/api/v1/rules/{id}"
    };
  }
  rpc ListRules(ListRulesRequest) returns (ListRulesResponse) {
    option (google.api.http) = {
      get: "/api/v1/rules"
    };
  }

  // --- RuleExecution operations ---
  rpc CreateRuleExecution(CreateRuleExecutionRequest) returns (models.RuleExecution) {
    option (google.api.http) = {
      post: "/api/v1/rule-executions"
      body: "rule_execution"
    };
  }
  rpc GetRuleExecution(GetRuleExecutionRequest) returns (models.RuleExecution) {
    option (google.api.http) = {
      get: "/api/v1/rule-executions/{id}"
    };
  }
  rpc UpdateRuleExecution(UpdateRuleExecutionRequest) returns (models.RuleExecution) {
    option (google.api.http) = {
      put: "/api/v1/rule-executions/{rule_execution.id}"
      body: "rule_execution"
    };
  }
  rpc ListRuleExecutions(ListRuleExecutionsRequest) returns (ListRuleExecutionsResponse) {
    option (google.api.http) = {
      get: "/api/v1/rule-executions"
    };
  }
}

// --- Asset Messages ---
message CreateAssetRequest {
  models.Asset asset = 1; // ID might be empty if generated server-side
}
message GetAssetRequest {
  string id = 1;
}
message UpdateAssetRequest {
  models.Asset asset = 1; // Must include ID and fields to update
  google.protobuf.FieldMask update_mask = 2; // Specifies which fields to update
}
message DeleteAssetRequest {
  string id = 1;
}
message ListAssetsRequest {
  optional int32 page_size = 1; // Number of assets to return
  optional string page_token = 2; // Token for fetching the next page
  repeated string tags = 3; // Filter by tags
}
message ListAssetsResponse {
  repeated models.Asset assets = 1;
  string next_page_token = 2; // Token for the next page, empty if no more pages
}

// --- Price Messages ---
message CreatePriceRequest {
  models.Price price = 1;
}
message CreatePricesRequest {
  repeated models.Price prices = 1;
}
message CreatePricesResponse {
  int32 created_count = 1; // Number of prices successfully created
}
message GetLatestPriceRequest {
  string asset_id = 1;
  string base_asset_id = 2;
  optional string source_id = 3;
}
message ListPriceHistoryRequest {
  string asset_id = 1;
  string base_asset_id = 2;
  optional google.protobuf.Timestamp from = 3; // Start of the time range
  optional google.protobuf.Timestamp to = 4; // End of the time range
  optional string source_id = 5; // Filter by source
  optional int32 page_size = 6; // Pagination for large history
  optional string page_token = 7;
}
message ListPriceHistoryResponse {
  repeated models.Price prices = 1;
  string next_page_token = 2;
}
message ListPricesByIntervalRequest {
  string asset_id = 1;
  string base_asset_id = 2;
  optional google.protobuf.Timestamp from = 3;
  optional google.protobuf.Timestamp to = 4;
  string interval = 5; // e.g., "hourly", "daily", "weekly" - specific values TBD
  optional string source_id = 6; // Filter by source
  optional int32 page_size = 7; // Pagination
  optional string page_token = 8;
}
message DeletePriceRequest {
    string id = 1;
}
message DeletePricesRequest {
    optional string asset_id = 1;
    optional string base_asset_id = 2;
    optional google.protobuf.Timestamp from = 3;
    optional google.protobuf.Timestamp to = 4;
    optional string source_id = 5; // Filter by source
}

// --- Portfolio Messages ---
message CreatePortfolioRequest {
  models.Portfolio portfolio = 1; // user_id and name are required. ID empty if server-generated.
}
message GetPortfolioRequest {
  string id = 1;
}
message UpdatePortfolioRequest {
  models.Portfolio portfolio = 1; // Must include ID and fields to update
  google.protobuf.FieldMask update_mask = 2;
}
message DeletePortfolioRequest {
  string id = 1;
}
message ListPortfoliosRequest {
  optional string user_id = 1;
  optional int32 page_size = 2;
  optional string page_token = 3;
}
message ListPortfoliosResponse {
  repeated models.Portfolio portfolios = 1;
  string next_page_token = 2;
}

// --- Holding Messages ---
message CreateHoldingRequest {
  models.Holding holding = 1; // asset_id, amount, decimals required. One of portfolio_id or account_id required. ID empty.
}
message GetHoldingRequest {
  string id = 1;
}
message UpdateHoldingRequest {
  models.Holding holding = 1; // Must include ID and fields to update (e.g., amount)
  google.protobuf.FieldMask update_mask = 2;
}
message ListHoldingsRequest {
  optional string portfolio_id = 1;
  optional string account_id = 2;
  optional string asset_id = 3;
  optional int32 page_size = 4;
  optional string page_token = 5;
}
message ListHoldingsResponse {
  repeated models.Holding holdings = 1;
  string next_page_token = 2;
}

// --- User Messages ---
message CreateUserRequest {
  models.User user = 1; // email, name required. ID empty.
}
message GetUserRequest {
  string id = 1;
}
message UpdateUserRequest {
  models.User user = 1; // Must include ID and fields to update
  google.protobuf.FieldMask update_mask = 2;
}
message DeleteUserRequest {
  string id = 1;
}

// --- Account Messages ---
message CreateAccountRequest {
  models.Account account = 1; // user_id, name, type required. ID empty.
}
message GetAccountRequest {
  string id = 1;
}
message UpdateAccountRequest {
  models.Account account = 1; // Must include ID and fields to update
  google.protobuf.FieldMask update_mask = 2;
}
message DeleteAccountRequest {
  string id = 1;
}
message ListAccountsRequest {
  optional string user_id = 1; // Filter by user
  optional models.AccountType type = 2; // Filter by AccountType
  optional int32 page_size = 3;
  optional string page_token = 4;
}
message ListAccountsResponse {
  repeated models.Account accounts = 1;
  string next_page_token = 2;
}

// --- Transaction Messages ---
message CreateTransactionRequest {
  models.Transaction transaction = 1; // Required fields depend on type. ID empty.
}
message GetTransactionRequest {
  string id = 1;
}
message UpdateTransactionRequest {
  models.Transaction transaction = 1; // Must include ID. Typically only 'status' or 'metadata' can be updated.
  google.protobuf.FieldMask update_mask = 2;
}
// message DeleteTransactionRequest { string id = 1; }
message ListTransactionsRequest {
  optional models.TransactionType type = 1;
  optional models.TransactionStatus status = 2;
  optional string account_id = 3;
  optional google.protobuf.Timestamp from = 4;
  optional google.protobuf.Timestamp to = 5;
  optional int32 page_size = 6;
  optional string page_token = 7;
}
message ListTransactionsResponse {
  repeated models.Transaction transactions = 1;
  string next_page_token = 2;
}

// --- Rule Messages ---
message CreateRuleRequest {
  models.Rule rule = 1; // name, rule_type, portfolio_id, user_id required. ID empty.
}
message GetRuleRequest {
  string id = 1;
}
message UpdateRuleRequest {
  models.Rule rule = 1; // Must include ID and fields to update
  google.protobuf.FieldMask update_mask = 2;
}
message DeleteRuleRequest {
  string id = 1;
}
message ListRulesRequest {
  optional string user_id = 1;
  optional string portfolio_id = 2;
  optional string rule_type = 3;
  optional models.RuleStatus status = 4;
  optional int32 page_size = 5;
  optional string page_token = 6;
}
message ListRulesResponse {
  repeated models.Rule rules = 1;
  string next_page_token = 2;
}

// --- RuleExecution Messages ---
message CreateRuleExecutionRequest {
  models.RuleExecution rule_execution = 1; // rule_id required. ID empty.
}
message GetRuleExecutionRequest {
  string id = 1;
}
message UpdateRuleExecutionRequest {
  models.RuleExecution rule_execution = 1; // Must include ID and fields to update
  google.protobuf.FieldMask update_mask = 2;
}
message ListRuleExecutionsRequest {
  optional string rule_id = 1;
  optional string portfolio_id = 2;
  optional string user_id = 3;
  optional models.ExecutionStatus status = 4;
  optional google.protobuf.Timestamp from = 5;
  optional google.protobuf.Timestamp to = 6;
  optional int32 page_size = 7;
  optional string page_token = 8;
}
message ListRuleExecutionsResponse {
  repeated models.RuleExecution rule_executions = 1;
  string next_page_token = 2;
}
