syntax = "proto3";

package models;

import "google/protobuf/timestamp.proto";
option go_package = "github.com/foxcool/greedy-eye/internal/api/models";

// TelegramUser represents a user linked between Telegram and the system
message TelegramUser {
    string telegram_id = 1;           // Telegram user ID
    string user_id = 2;               // System User ID (link to User model)
    string username = 3;              // Telegram username (@username)
    string first_name = 4;            // User's first name in Telegram
    string last_name = 5;             // User's last name in Telegram
    string language_code = 6;         // User's language preference (ru, en)
    bool notifications_enabled = 7;   // Whether notifications are enabled
    repeated string subscribed_alerts = 8;  // List of alert types user subscribed to
    google.protobuf.Timestamp created_at = 9;
    google.protobuf.Timestamp last_active = 10;
}

// SessionContext represents user conversation state
message SessionContext {
    string telegram_id = 1;          // Telegram user ID
    string current_operation = 2;    // Current operation: "trade", "portfolio_view", etc.
    map<string, string> context_data = 3;  // Key-value context data
    google.protobuf.Timestamp expires_at = 4;  // Session expiration time
    repeated string conversation_history = 5;  // Recent conversation history
    string state = 6;                // Current conversation state
}

// TelegramMessage represents incoming message from Telegram
message TelegramMessage {
    string message_id = 1;           // Telegram message ID
    string telegram_id = 2;          // Sender's Telegram ID
    MessageType type = 3;            // Message type
    string content = 4;              // Message content (text or file path)
    string language = 5;             // Detected language
    google.protobuf.Timestamp received_at = 6;
    map<string, string> metadata = 7;  // Additional metadata (file size, duration, etc.)
}

// TelegramResponse represents outgoing response to Telegram
message TelegramResponse {
    string telegram_id = 1;          // Target Telegram user ID
    ResponseType type = 2;           // Response type
    string content = 3;              // Response content
    ResponseFormat format = 4;       // Response format
    repeated InlineButton buttons = 5;  // Inline keyboard buttons
    bool enable_voice_response = 6;  // Whether to also send voice response
}

// InlineButton represents Telegram inline keyboard button
message InlineButton {
    string text = 1;                 // Button text
    string callback_data = 2;        // Callback data when pressed
    string url = 3;                  // URL to open (mutually exclusive with callback_data)
}

// Notification represents push notification to user
message TelegramNotification {
    string telegram_id = 1;          // Target user Telegram ID
    NotificationType type = 2;       // Notification type
    string title = 3;                // Notification title
    string message = 4;              // Notification message
    string asset_symbol = 5;         // Related asset (if applicable)
    string portfolio_id = 6;         // Related portfolio (if applicable)
    double value = 7;                // Related value (price, change, etc.)
    google.protobuf.Timestamp created_at = 8;
    bool sent = 9;                   // Whether notification was sent successfully
}

// TelegramAlert represents transport-specific alert configuration
// Business logic moved to Rule system - this handles only Telegram-specific concerns
message TelegramAlert {
    string id = 1;                   // Alert ID
    string telegram_id = 2;          // Owner Telegram ID
    string rule_id = 3;              // Link to Rule (business logic)
    string custom_message = 4;       // Custom Telegram message template (optional)
    bool enabled = 5;                // Whether Telegram delivery is enabled
    google.protobuf.Timestamp created_at = 6;
    google.protobuf.Timestamp last_triggered = 7;
    int32 trigger_count = 8;         // Telegram delivery count
    
    // Deprecated fields - will be removed after migration
    reserved 9 to 12;               // Reserved for old alert_type, condition, etc.
    reserved "alert_type", "asset_symbol", "portfolio_id", "condition", "threshold_value";
}

// Enums
enum MessageType {
    MESSAGE_TYPE_UNSPECIFIED = 0;
    MESSAGE_TYPE_TEXT = 1;
    MESSAGE_TYPE_VOICE = 2;
    MESSAGE_TYPE_COMMAND = 3;
    MESSAGE_TYPE_CALLBACK = 4;
}

enum ResponseType {
    RESPONSE_TYPE_UNSPECIFIED = 0;
    RESPONSE_TYPE_TEXT = 1;
    RESPONSE_TYPE_VOICE = 2;
    RESPONSE_TYPE_PHOTO = 3;
    RESPONSE_TYPE_DOCUMENT = 4;
}

enum ResponseFormat {
    RESPONSE_FORMAT_UNSPECIFIED = 0;
    RESPONSE_FORMAT_PLAIN = 1;
    RESPONSE_FORMAT_MARKDOWN = 2;
    RESPONSE_FORMAT_HTML = 3;
}

// Simplified transport-focused notification types
// Business logic conditions moved to Rule system
enum NotificationType {
    NOTIFICATION_TYPE_UNSPECIFIED = 0;
    NOTIFICATION_TYPE_ALERT = 1;          // Rule-triggered alerts (price, portfolio, etc.)
    NOTIFICATION_TYPE_SYSTEM = 2;         // System status, sync, trade confirmations
    NOTIFICATION_TYPE_REPORT = 3;         // Scheduled reports (weekly, monthly)
}


